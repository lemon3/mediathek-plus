// ==UserScript==
// @name         ORF DL
// @namespace    https://github.com/lemon3/
// @version      0.7.1
// @description  orf tvthek video download helper
// @author       lemon3
// @match        https://on.orf.at/video/*
// @icon         https://raw.githubusercontent.com/lemon3/orfdl/main/_assets/dl.svg
// @grant        none
// @run-at       document-end
// @license      MIT
// @copyright    lemon3
// @homepage     https://github.com/lemon3/orfdl
// @updateURL    https://raw.githubusercontent.com/lemon3/orfdl/main/dist/orfdl.meta.js
// @downloadURL  https://raw.githubusercontent.com/lemon3/orfdl/main/dist/orfdl.user.js
// ==/UserScript==

var te=Object.defineProperty;var _=Object.getOwnPropertySymbols;var se=Object.prototype.hasOwnProperty,ie=Object.prototype.propertyIsEnumerable;var E=(d,l,r)=>l in d?te(d,l,{enumerable:!0,configurable:!0,writable:!0,value:r}):d[l]=r,O=(d,l)=>{for(var r in l||(l={}))se.call(l,r)&&E(d,r,l[r]);if(_)for(var r of _(l))ie.call(l,r)&&E(d,r,l[r]);return d};var c=(d,l,r)=>(E(d,typeof l!="symbol"?l+"":l,r),r);var D=(d,l,r)=>new Promise((a,w)=>{var A=g=>{try{L(r.next(g))}catch(x){w(x)}},v=g=>{try{L(r.throw(g))}catch(x){w(x)}},L=g=>g.done?a(g.value):Promise.resolve(g.value).then(A,v);L((r=r.apply(d,l)).next())});(function(){"use strict";const d="body.dragging>*{-webkit-touch-callout:none;-webkit-user-select:none;user-select:none}#l3-4004{--color-1: #000;--color-2: #222;--color-3: #72bbe9;--color-4: #c9c9c9;--color-5: #222222;--color-6: #555555;--color-7: #aedaf5;--font-small: 12px;--font-tiny: 10px}#l3-4004{position:fixed;top:0;left:0;z-index:99999;font-family:Arial,Helvetica Neue,Helvetica,sans-serif;color:var(--color-4)}#l3-4004 .l3-4004-info{font-size:var(--font-small)}#l3-4004-body .l3-4004-info{padding:15px}#l3-4004-clear{color:var(--color-1);background-color:var(--color-3);width:32px;height:38px;box-sizing:border-box;flex:none;text-align:center;justify-content:center;padding:.5em;cursor:pointer}#l3-4004-header{width:100%;padding:15px}#l3-4004-header.hidden{display:none}.l3-4004-buttons{display:flex;font-size:14px;gap:.5em}.l3-4004-button{font-size:var(--font-small);color:var(--color-4);background-color:var(--color-5);cursor:pointer;display:flex;flex:1 1 auto;justify-content:center;text-align:center;width:50%;padding:.5em;border-radius:6px}.l3-4004-button.active{color:var(--color-2);background-color:var(--color-3)}.l3-4004-button.active:hover{background-color:var(--color-7)}#l3-4004-filter{display:flex;align-items:stretch;margin-top:.5em}#l3-4004-filter.hidden{display:none}#l3-4004-content{max-height:260px;overflow:scroll}#l3-4004-close{z-index:999999;position:absolute;top:19px;left:15px;padding:0;background-image:url(data:image/svg+xml;base64,PHN2ZyBlbmFibGUtYmFja2dyb3VuZD0ibmV3IDAgMCAyNTYgMjU2IiB2aWV3Qm94PSIwIDAgMjU2IDI1NiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyBmaWxsPSIjZmZmIj48cGF0aCBkPSJtMjQzLjIgMTE5LjZ2MTYuOGgtMjMwLjR2LTE2Ljh6Ii8+PHBhdGggZD0ibTI0My4yIDE3NC42djE2LjhoLTIzMC40di0xNi44eiIvPjxwYXRoIGQ9Im0yNDMuMiA2NC42djE2LjhoLTIzMC40di0xNi44eiIvPjwvZz48L3N2Zz4=);background-repeat:no-repeat;width:38px;height:38px;background-size:20px;background-color:var(--color-1);border-radius:50%;background-position:center center;box-shadow:0 2px 12px -3px #fffc;cursor:pointer;user-select:none}#l3-4004-close.open{background-image:url(data:image/svg+xml;base64,PHN2ZyBlbmFibGUtYmFja2dyb3VuZD0ibmV3IDAgMCAyNTYgMjU2IiB2aWV3Qm94PSIwIDAgMjU2IDI1NiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJtMjQ2LjUgMjM0LjctMTA2LjctMTA2LjcgMTA2LjctMTA2LjctMTEuOC0xMS45LTEwNi43IDEwNi43LTEwNi43LTEwNi42LTExLjggMTEuOSAxMDYuNiAxMDYuNi0xMDYuNiAxMDYuNiAxMS44IDExLjkgMTA2LjctMTA2LjYgMTA2LjcgMTA2Ljd6IiBmaWxsPSIjZmZmIi8+PC9zdmc+)}#l3-4004-field{font-size:16px;touch-action:none;padding:8px;height:38px;border:0;border-radius:0;color:var(--color-2);width:100%}#l3-4004-field:focus{outline:none}#l3-4004-box{z-index:999999;box-sizing:border-box;margin:0;top:64px;max-width:280px;width:280px;background-color:var(--color-1);transform:translate(-100%);position:relative;transition:transform .1s ease-out;border:1px solid var(--color-5);box-shadow:0 2px 12px -3px #fffc;border-radius:6px}#l3-4004-box.open{transform:translate(0);transition:transform .2s ease-out}#l3-4004 .l3-4004-shareBtn{background-image:url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCI+PHBhdGggZD0iTTE1Ljk4NCA1LjAxNmwtMS40MDYgMS40MDYtMS41OTQtMS41OTR2MTEuMTU2aC0xLjk2OVY0LjgyOEw5LjQyMSA2LjQyMiA4LjAxNSA1LjAxNiAxMS45OTkuOTg1em00LjAzMiA0Ljk2OFYyMXEwIC44NDQtLjU4NiAxLjQzdC0xLjQzLjU4Nkg2cS0uODQ0IDAtMS40My0uNTg2VDMuOTg0IDIxVjkuOTg0cTAtLjc5Ny41ODYtMS4zODNUNiA4LjAxNWgzdjEuOTY5SDZWMjFoMTJWOS45ODRoLTNWOC4wMTVoM3EuODQ0IDAgMS40My41ODZ0LjU4NiAxLjM4M3oiLz48L3N2Zz4=);width:32px;height:32px;background-color:var(--color-3);display:flex;background-size:70%;background-repeat:no-repeat;background-position:center center;flex:none;border:none;border-radius:6px}#l3-4004 .l3-4004-shareBtn:hover{background-color:var(--color-7);cursor:pointer}#l3-4004 .l3-4004-result{display:flex;flex-flow:row wrap;padding:1em}#l3-4004 .l3-4004-result:nth-child(odd){background-color:var(--color-5)}#l3-4004 .l3-4004-bar{width:100%;flex:1 1 100%;font-size:var(--font-small);display:flex;justify-content:space-between;align-items:center;margin-bottom:.5em}#l3-4004 .l3-4004-title{display:flex;padding:.5em .5em .5em 0;line-height:1.4em}#l3-4004 .l3-4004-copy{font-size:30px}#l3-4004 .l3-4004-imgWrap{width:100%;display:flex;position:relative}#l3-4004 .l3-4004-copy{position:absolute;text-align:center;width:100%;left:0;top:35%;background-color:#0006;padding:10px;opacity:0;transition:opacity ease-out .2s}#l3-4004 .success .l3-4004-copy{opacity:1}.l3-4004-imgWrap.active{box-shadow:0 0 0 2px #ffff54;filter:brightness(1.2)}#l3-4004-footer{font-size:var(--font-tiny);text-align:right;padding:.5em}",l=(n,e,t)=>{if(n=parseFloat(n,10),e=parseFloat(e,10),t=parseFloat(t,10),t<e){let i=t;t=e,e=i}return!isNaN(e)&&n<e?e:!isNaN(t)&&n>t?t:n},r=(n,e,t)=>{if(e)for(let i in e)Object.prototype.hasOwnProperty.call(e,i)&&n.setAttribute(i,e[i]);if(t)for(let i in t)Object.prototype.hasOwnProperty.call(t,i)&&(n.style[i]=t[i]);return n},a=(n,e,t)=>r(document.createElement(n),e,t),w=(n="cs",e=window)=>{var t=document.createElement("iframe");t.src="about:blank",t.style.display="none",document.body.appendChild(t);const i=t.contentWindow.console;return e[n]=i};class A{constructor(){}get(e,t){let i=localStorage.getItem(e);if(!i)return!1;let o=JSON.parse(i);return t?o[t]:o}set(e,t){const i=this.get(e)||{},o=O(O({},i),t);let s=JSON.stringify(o);localStorage.setItem(e,s)}}let v=!1;try{window.addEventListener("test",null,Object.defineProperty({},"passive",{get:function(){return v={passive:!1},!1}}))}catch(n){v=!1}const C={name:"orfdl",displayName:"ORF DL",version:"0.7.1",type:"module",description:"orf tvthek video download helper",main:"index.js",author:"lemon3",license:"MIT",scripts:{dev:"vite",build:"vite build",preview:"vite preview",lint:"eslint 'src/**/*.js' || true",prettify:"prettier --write 'src/**/*.*'",browserslistupdate:"npx update-browserslist-db@latest"},devDependencies:{eslint:"^9.3.0",prettier:"^3.2.5",vite:"^5.2.11","vite-plugin-banner":"^0.7.1","vite-plugin-create-file":"^0.1.0","vite-plugin-string-replace":"^1.1.2"},dependencies:{globals:"^15.3.0"}},j=w("cs"),F={btn:"Click on the image to copy the video-link to the clipboard"},P=C.version;let H="Q8C",Z="hls";const Y=d.toString();let f;const I=n=>{n.advertising_mapping={},n.advertising_query_string="",n.adition_advertising_query_string="",n.show_display_ads=!1,n.show_instream_ads=!1,n.youth_protection=void 0,n.age_classification=void 0,n.disable_display_ads_orf_platforms=!0,n.disable_instream_ads_orf_platforms=!0},M=(n,e=2)=>("0"+n).slice(-e),W=n=>{let e=n.target.parentElement.nextElementSibling;if(e.select(),navigator.clipboard){let t=e.innerHTML;return navigator.clipboard.writeText(t).then(()=>console.log("successful"),i=>console.log("error",i))}return document.execCommand("copy")},U=n=>{if(!navigator.share)return!1;const e=n.target,t=e.dataset.shareTitle,i=e.dataset.shareUrl;navigator.share({title:t,url:i}).then(()=>console.log("successful share")).catch(o=>console.log("error sharing:",o))},k=n=>{let e;return typeof n.clientX!="undefined"?e=n:e=n.touches[0]||n.changedTouches[0],{x:e.clientX,y:e.clientY}};class T{constructor(e){c(this,"renderSearchResults",e=>{if(this.contentDiv.innerHTML="",!e.length)return null;const t="div",i=new DocumentFragment;for(let o=e.length-1;o>=0;o--){const s=e[o],h=a(t,{class:"l3-4004-result"}),m=a(t,{class:"l3-4004-bar"}),u=a(t,{class:"l3-4004-title"});u.innerHTML=s.title,m.append(u);const y=a("textarea",{class:"l3-4004-ta",disabled:"true"},{position:"absolute",left:"-999em",opacity:0}),b=a(t,{class:"l3-4004-imgWrap",title:F.btn}),p=a(t,{class:"l3-4004-copy"},{display:"none"});p.innerHTML="copied";const B=a("img",{src:s.img,width:"150"},{flex:"auto"});B.dataset.drm=s.drm===null?!1:s.drm,b.append(B),b.append(p);let N;if(!s.drm){const G=s.date.getFullYear(),$=M(+s.date.getMonth()+1),R=M(s.date.getDate()),X=M(s.date.getHours()),q=M(s.date.getMinutes()),J=`${G}-${$}-${R}`,K=`${X}${q}`;let z=s.title.toLowerCase().replaceAll('"',"");z.replaceAll("'","");const ee=`${J}_${K}_${z}.mp4`;N=`yt-dlp ${s.link} -o '${ee}'`;const S=a("button",{class:"l3-4004-shareBtn"});S.dataset.share=!0,S.dataset.shareUrl=s.link,S.title="share video link",m.append(S)}y.innerHTML=N,h.append(m),h.append(b),h.append(y),i.append(h)}this.contentDiv.append(i)});c(this,"contentClicked",e=>{const t=e.target;if(this.currentActive&&(this.currentActive.classList.remove("active"),this.currentActive.querySelector(".l3-4004-copy").style.display="none"),t.nodeName.toLocaleLowerCase()==="img"&&t.dataset.drm&&t.dataset.drm==="false"){if(W(e)){const o=t.parentElement,s=o.querySelector(".l3-4004-copy");clearTimeout(f),s.style.display="block",f=setTimeout(()=>{o.classList.add("active"),o.classList.add("success"),f=setTimeout(()=>{o.classList.remove("success"),f=setTimeout(()=>{s.style.display="none"},200)},500)},1),this.currentActive=o}}else t.nodeName.toLocaleLowerCase()==="button"&&typeof t.dataset.share!="undefined"&&U(e)});c(this,"dragStart",e=>{this.moved=!1,document.body.classList.add("dragging"),e.stopPropagation(),e.type==="touchstart"?(this.closeBtn.removeEventListener("mousedown",this.dragStart),window.addEventListener("touchmove",this.drag,v),window.addEventListener("touchend",this.dragEnd,!1)):e.type==="mousedown"&&(this.closeBtn.removeEventListener("touchstart",this.dragStart),window.addEventListener("mousemove",this.drag,!1),window.addEventListener("mouseup",this.dragEnd,!1))});c(this,"drag",e=>{e.preventDefault();let t=k(e);this.moved=!0,this.setPos(t)});c(this,"dragEnd",e=>{e.type==="touchend"?(window.removeEventListener("touchmove",this.drag,v),window.removeEventListener("touchend",this.dragEnd)):e.type==="mouseup"&&(window.removeEventListener("mousemove",this.drag,!1),window.removeEventListener("mouseup",this.dragEnd,!1));let{x:t,y:i}=k(e);this.store.set(this.name,{posX:t,posY:i}),document.body.classList.remove("dragging")});c(this,"open",()=>{this.mainDiv.style.display="block",f=setTimeout(()=>{this.mainDiv.classList.add("open"),this.closeBtn.classList.add("open"),this.searchField&&this.searchField.focus(),this.isOpen=!0,this.store.set(this.name,{open:this.isOpen}),clearTimeout(f)},1)});c(this,"close",()=>{this.mainDiv.classList.remove("open"),this.closeBtn.classList.remove("open"),f=setTimeout(()=>{this.mainDiv.style.display="none",this.isOpen=!1,this.store.set(this.name,{open:this.isOpen}),clearTimeout(f)},100)});c(this,"toggle",()=>{if(this.moved)return!1;this.isOpen?this.close():this.open()});c(this,"orfOnFetchData",()=>D(this,null,function*(){let e=0,t;return new Promise((i,o)=>{const s=()=>{window.__NUXT__||o(),e++;const h=window.__NUXT__.data,m=Object.entries(h);let u;if(m.forEach(y=>{const[b,p]=y;if(p.sources&&document.location.pathname.match(p.id)){u=p,I(p),this.currentKey=b;return}}),u)e=0,i(u);else{if(e>20)return clearTimeout(t),t=null,o();t=setTimeout(()=>s(),150)}};s()})}));c(this,"clear",()=>{this.searchField.value="",this.searchField.dispatchEvent(new Event("input")),this.searchField.focus()});c(this,"onInput",e=>{const t=e.currentTarget.value;this.searchNow(t),this.toggleClearBtn(t==="")});c(this,"createDataObject",()=>D(this,null,function*(){let e;try{e=yield this.orfOnFetchData()}catch(t){return console.log(t),!1}return this.createOrfOn(e)}));c(this,"showAll",()=>{if(this.activeTab==="1")return!1;this.showAllButton.classList.add("active"),this.showSegmentsButton.classList.remove("active");const e=this.findData("*");this.filterElement.classList.add("hidden"),this.renderSearchResults(e),this.setActiveTab(1)});c(this,"showSegments",()=>{if(this.activeTab==="2")return!1;this.showAllButton.classList.remove("active"),this.showSegmentsButton.classList.add("active"),this.filterElement.classList.remove("hidden");let e=this.oldSearchString||this.searchField.value;this.toggleClearBtn(!e),this.searchField.focus(),this.oldSearchString=null,this.searchNow(e),this.setActiveTab(2)});c(this,"resize",()=>{this.windowWidth=window.innerWidth,this.windowHeight=window.innerHeight});c(this,"reInit",()=>{this.currentKey=null,this.autoSearch=this.oldSearchString,this.oldSearchString=null,this.contentDiv.innerHTML="",this.start()});c(this,"start",()=>D(this,null,function*(){if(this.dataObject=yield this.createDataObject(),!this.dataObject||!this.dataObject.length)return;if(this.dataObject&&this.dataObject.length===2){this.header.classList.add("hidden");const t=this.dataObject.filter(i=>i.type==="single");this.renderSearchResults(t)}else this.header.classList.remove("hidden"),this.searchField.value=this.autoSearch,j.log("activeTab",this.activeTab),this.activeTab===1?this.showAll():this.activeTab===2&&this.showSegments()}));this.settings=Object.assign({},T.defaults,e),this.name="dl-app",this.autoSearch="",this.oldSearchString=null,this.dataObject=[],this.createWatcher(),this.settings.createGui&&this.createApp(),this.store=new A,this.init()}createWatcher(){const e=document.querySelector('link[rel="canonical"]'),t={attributes:!0,subtree:!0,attributeOldValue:!0},i=s=>{for(const h of s)h.type==="attributes"&&this.reInit()};new MutationObserver(i).observe(e,t)}setPos({x:e,y:t}){e-=19,t-=19,e=l(e,0,this.windowWidth-38),t=l(t,0,this.windowHeight-38),this.closeBtn.style.left=e+"px",this.closeBtn.style.top=t+"px"}findData(e){if(!this.dataObject)return null;const t=e==="*"?"all":"single";return this.dataObject.filter(o=>o.type===t&&(e==="*"||o.title.toLowerCase().match(e.replaceAll("*",".*").toLowerCase())))}searchNow(e){if(this.oldSearchString===e)return;const t=this.findData(e);this.renderSearchResults(t),this.store.set(this.name,{search:e}),this.oldSearchString=e}toggleClearBtn(e){if(e){this.clearBtn.style.display="none",this.clearBtnVisible=!1;return}this.clearBtnVisible||(this.clearBtn.style.display="flex",this.clearBtnVisible=!0)}createOrfOn(e){window.playerObject=e;const t=[],i=(s,h="single")=>{I(s);let m=null,u=s.date||s.episode_date;u=new Date(u),s.sources[Z].forEach(p=>{p.quality_key.toLocaleLowerCase()==="qxa"&&(m=p.src.replace("QXA",H))});const y=typeof s.is_drm_protected!="undefined"?s.is_drm_protected:null;return{type:h,title:s.headline||s.title,drm:y,date:u,link:m,img:s.image&&s.image.image&&s.image.image.player&&s.image.image.player.url||null}},o=i(e,"all");return t.push(o),e.segments&&e.segments.forEach(s=>{const h=i(s);t.push(h)}),t}createApp(){const e="div",t=a(e,{id:"l3-4004"}),i=a(e,{id:"l3-4004-body"});this.mainDiv=a(e,{id:"l3-4004-box"},{display:"none"}),this.header=a(e,{id:"l3-4004-header"}),this.showAllButton=a(e,{class:"l3-4004-button"}),this.showAllButton.innerHTML="Ganze Sendung anzeigen",this.showSegmentsButton=a(e,{class:"l3-4004-button"}),this.showSegmentsButton.innerHTML="Einzelne Beiträge anzeigen",this.buttons=a(e,{class:"l3-4004-buttons"}),this.buttons.append(this.showAllButton,this.showSegmentsButton),this.header.append(this.buttons),this.filterElement=a(e,{id:"l3-4004-filter"}),this.searchField=a("input",{type:"text",id:"l3-4004-field",name:"fake_user[name]",value:"",autocomplete:"new-password",spellcheck:"false","aria-autocomplete":"none",placeholder:"filter videos by name ..."}),this.clearBtn=document.createElement(e),this.clearBtn.id="l3-4004-clear",this.clearBtn.innerHTML="X",this.toggleClearBtn(!0),this.filterElement.append(this.searchField,this.clearBtn),this.header.append(this.filterElement),this.clearBtn.addEventListener("click",this.clear,!1),this.searchField.addEventListener("input",this.onInput,!1),this.mainDiv.append(this.header),this.closeBtn=a(e,{id:"l3-4004-close"}),this.closeBtn.addEventListener("click",this.toggle),window.addEventListener("resize",this.resize),this.resize(),this.closeBtn.addEventListener("mousedown",this.dragStart),this.closeBtn.addEventListener("touchstart",this.dragStart,v),this.contentDiv=a(e,{id:"l3-4004-content"});const o=a(e,{id:"l3-4004-footer"});o.innerHTML=`v-${P}`,i.append(this.contentDiv),this.mainDiv.append(i,o),t.append(this.mainDiv,this.closeBtn);const s=a("style");s.innerHTML=Y,document.body.append(s),document.body.append(t),t.addEventListener("click",this.contentClicked),this.showAllButton.addEventListener("click",this.showAll),this.showSegmentsButton.addEventListener("click",this.showSegments),this.app=t}setActiveTab(e){this.store.set(this.name,{activeTab:e}),this.activeTab=e}init(){let e=this.store.get(this.name);this.activeTab=1,e&&(typeof e.search!="undefined"&&(this.autoSearch=e.search),typeof e.open!="undefined"&&(this.isOpen=e.open),typeof e.posX!="undefined"&&typeof e.posY!="undefined"&&this.setPos({x:e.posX,y:e.posY}),typeof e.activeTab!="undefined"&&(this.activeTab=+e.activeTab)),j.log(e),j.log(this.activeTab),this.start(),this.isOpen&&(this.mainDiv.classList.add("open"),this.mainDiv.style.display="block",this.closeBtn.classList.add("open"))}}T.defaults={createGui:!0};const V=()=>{if(window.orfdl_initialized)return!1;window.orfdl_initialized=!0,new T};let Q=setInterval(()=>{V(),window.orfdl_initialized&&clearInterval(Q)},10)})();
