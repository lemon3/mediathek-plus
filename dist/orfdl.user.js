// ==UserScript==
// @name         ORF DL
// @namespace    https://github.com/lemon3/
// @version      0.6.0
// @description  orf tvthek video download helper
// @author       lemon3
// @match        https://*.tvthek.orf.at/profile/*
// @match        https://on.orf.at/video/*
// @icon         https://raw.githubusercontent.com/lemon3/orfdl/main/_assets/dl.svg
// @grant        none
// @run-at       document-end
// @license      MIT
// @copyright    lemon3
// @homepage     https://github.com/lemon3/orfdl
// @updateURL    https://raw.githubusercontent.com/lemon3/orfdl/main/dist/orfdl.meta.js
// @downloadURL  https://raw.githubusercontent.com/lemon3/orfdl/main/dist/orfdl.user.js
// ==/UserScript==

var Oe=Object.defineProperty;var ne=Object.getOwnPropertySymbols;var Se=Object.prototype.hasOwnProperty,ze=Object.prototype.propertyIsEnumerable;var oe=(y,d,i)=>d in y?Oe(y,d,{enumerable:!0,configurable:!0,writable:!0,value:i}):y[d]=i,Q=(y,d)=>{for(var i in d||(d={}))Se.call(d,i)&&oe(y,i,d[i]);if(ne)for(var i of ne(d))ze.call(d,i)&&oe(y,i,d[i]);return y};var Y=(y,d,i)=>new Promise(($,E)=>{var M=L=>{try{N(i.next(L))}catch(k){E(k)}},W=L=>{try{N(i.throw(L))}catch(k){E(k)}},N=L=>L.done?$(L.value):Promise.resolve(L.value).then(M,W);N((i=i.apply(y,d)).next())});(function(){"use strict";const y="#l3-9556{--color-1: #000;--color-2: #222;--color-3: #72bbe9;--color-4: #c9c9c9;--color-5: #222222;--font-small: 12px;--font-tiny: 10px}#l3-9556{position:fixed;top:0;left:0;z-index:99999;font-family:Arial,Helvetica Neue,Helvetica,sans-serif;color:var(--color-4)}#l3-9556 .l3-9556-info{font-size:var(--font-small)}#l3-9556-body .l3-9556-info{padding:15px}#l3-9556-clear{color:var(--color-1);background-color:var(--color-3);width:32px;height:38px;box-sizing:border-box;flex:none;text-align:center;justify-content:center;padding:.5em;cursor:pointer}#l3-9556-header{width:100%;padding:15px}#l3-9556-filter{display:flex;align-items:stretch;margin-top:.5em}#l3-9556-content{max-height:260px;overflow:scroll}#l3-9556-close{z-index:999999;position:absolute;top:19px;left:15px;padding:0;background-image:url(data:image/svg+xml;base64,PHN2ZyBlbmFibGUtYmFja2dyb3VuZD0ibmV3IDAgMCAyNTYgMjU2IiB2aWV3Qm94PSIwIDAgMjU2IDI1NiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyBmaWxsPSIjZmZmIj48cGF0aCBkPSJtMjQzLjIgMTE5LjZ2MTYuOGgtMjMwLjR2LTE2Ljh6Ii8+PHBhdGggZD0ibTI0My4yIDE3NC42djE2LjhoLTIzMC40di0xNi44eiIvPjxwYXRoIGQ9Im0yNDMuMiA2NC42djE2LjhoLTIzMC40di0xNi44eiIvPjwvZz48L3N2Zz4=);background-repeat:no-repeat;width:38px;height:38px;background-size:20px;background-color:var(--color-1);border-radius:50%;background-position:center center;box-shadow:0 2px 12px -3px #fffc;cursor:pointer}#l3-9556-close.open{background-image:url(data:image/svg+xml;base64,PHN2ZyBlbmFibGUtYmFja2dyb3VuZD0ibmV3IDAgMCAyNTYgMjU2IiB2aWV3Qm94PSIwIDAgMjU2IDI1NiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJtMjQ2LjUgMjM0LjctMTA2LjctMTA2LjcgMTA2LjctMTA2LjctMTEuOC0xMS45LTEwNi43IDEwNi43LTEwNi43LTEwNi42LTExLjggMTEuOSAxMDYuNiAxMDYuNi0xMDYuNiAxMDYuNiAxMS44IDExLjkgMTA2LjctMTA2LjYgMTA2LjcgMTA2Ljd6IiBmaWxsPSIjZmZmIi8+PC9zdmc+)}#l3-9556-field{font-size:16px;touch-action:none;padding:8px;height:38px;border:0;border-radius:0;color:var(--color-2);width:100%}#l3-9556-field:focus{outline:none}#l3-9556-box{z-index:999999;box-sizing:border-box;margin:0;top:64px;max-width:280px;width:280px;background-color:var(--color-1);transform:translate(-100%);position:relative;transition:transform .1s ease-out;border:1px solid var(--color-5)}#l3-9556-box.open{transform:translate(0);transition:transform .2s ease-out}#l3-9556 .l3-9556-shareBtn{background-image:url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCI+PHBhdGggZD0iTTE1Ljk4NCA1LjAxNmwtMS40MDYgMS40MDYtMS41OTQtMS41OTR2MTEuMTU2aC0xLjk2OVY0LjgyOEw5LjQyMSA2LjQyMiA4LjAxNSA1LjAxNiAxMS45OTkuOTg1em00LjAzMiA0Ljk2OFYyMXEwIC44NDQtLjU4NiAxLjQzdC0xLjQzLjU4Nkg2cS0uODQ0IDAtMS40My0uNTg2VDMuOTg0IDIxVjkuOTg0cTAtLjc5Ny41ODYtMS4zODNUNiA4LjAxNWgzdjEuOTY5SDZWMjFoMTJWOS45ODRoLTNWOC4wMTVoM3EuODQ0IDAgMS40My41ODZ0LjU4NiAxLjM4M3oiLz48L3N2Zz4=);width:32px;height:32px;background-color:var(--color-3);display:flex;background-size:70%;background-repeat:no-repeat;background-position:center center;flex:none;border:none}#l3-9556 .l3-9556-shareBtn:hover{background-color:var(--color-4);cursor:pointer}#l3-9556 .l3-9556-result{display:flex;flex-flow:row wrap;padding:1em}#l3-9556 .l3-9556-result:nth-child(odd){background-color:var(--color-5)}#l3-9556 .l3-9556-bar{width:100%;flex:1 1 100%;font-size:var(--font-small);display:flex;justify-content:space-between;align-items:center;margin-bottom:.5em}#l3-9556 .l3-9556-title{display:flex;padding:.5em .5em .5em 0;line-height:1.4em}#l3-9556 .l3-9556-copy{font-size:30px}#l3-9556 .l3-9556-imgWrap{width:100%;display:flex;position:relative}#l3-9556 .l3-9556-copy{position:absolute;text-align:center;width:100%;left:0;top:35%;background-color:#0006;padding:10px;opacity:0;transition:opacity ease-out .2s}#l3-9556 .success .l3-9556-copy{opacity:1}#l3-9556 .active{box-shadow:0 0 0 2px #ffff54;filter:brightness(1.2)}#l3-9556-footer{font-size:var(--font-tiny);text-align:right}",d=(e,t,o)=>{if(t)for(let n in t)Object.prototype.hasOwnProperty.call(t,n)&&e.setAttribute(n,t[n]);if(o)for(let n in o)Object.prototype.hasOwnProperty.call(o,n)&&(e.style[n]=o[n]);return e},i=(e,t,o)=>d(document.createElement(e),t,o),$=(e="cs",t=window)=>{var o=document.createElement("iframe");o.src="about:blank",o.style.display="none",document.body.appendChild(o);const n=o.contentWindow.console;return t[e]=n};class E{constructor(){}get(t,o){let n=localStorage.getItem(t);if(!n)return!1;let s=JSON.parse(n);return o?s[o]:s}set(t,o){const n=this.get(t)||{},s=Q(Q({},n),o);let a=JSON.stringify(s);localStorage.setItem(t,a)}}let M=!1;try{window.addEventListener("test",null,Object.defineProperty({},"passive",{get:function(){return M={passive:!1},!1}}))}catch(e){M=!1}const se={name:"orfdl",displayName:"ORF DL",version:"0.6.0",type:"module",description:"orf tvthek video download helper",main:"index.js",author:"lemon3",license:"MIT",scripts:{dev:"vite",build:"vite build",preview:"vite preview",lint:"eslint 'src/**/*.js' || true",prettify:"prettier --write 'src/**/*.*'",browserslistupdate:"npx update-browserslist-db@latest"},devDependencies:{eslint:"^9.2.0",prettier:"^3.2.5",vite:"^5.2.11","vite-plugin-banner":"^0.7.1","vite-plugin-string-replace":"^1.1.2"},dependencies:{globals:"^15.2.0"}},ie=$("cs");window.cs=ie;let G=document.location.href;const ae=document.querySelector("body");new MutationObserver(()=>{G!==document.location.href&&(G=document.location.href,_e())}).observe(ae,{childList:!0,subtree:!0});const q={btn:"Click on the image to copy the video-link to the clipboard"},le=se.version,A="dl-app";let T=!0,O="",_,re="Q8C",X="hls";const ce=y.toString();let x,F,b=[],S,v,z,D,h,f,I,C,P;const de=e=>{if(!e)return new Date;const t=e.match(/(\d{4})[_-](\d\d)[_-](\d\d)[_-](\d{4})/);if(!t)return new Date;const o=t[1],n=t[2],s=t[3],a=t[4].slice(0,-2)+":"+t[4].slice(2);return new Date(`${o}-${n}-${s} ${a}`)},pe=e=>{e.advertising_mapping={},e.advertising_query_string="",e.adition_advertising_query_string="",e.show_display_ads=!1,e.show_instream_ads=!1,e.disable_display_ads_orf_platforms=!0,e.disable_instream_ads_orf_platforms=!0},ue=()=>Y(this,null,function*(){let e=0,t;return new Promise((o,n)=>{const s=()=>{e++;const a=window.__NUXT__.data,r=Object.entries(a);let l;if(r.forEach(p=>{const[m,g]=p;if(g.sources){l=g,pe(g),P=m;return}}),l)e=0,o(l);else{if(e>20)return clearTimeout(t),t=null,n();t=setTimeout(()=>s(),150)}};s()})}),fe=e=>{window.playerObject=e;const t=[],o=(s,a="single")=>{let r=null,l=s.date||s.episode_date;l=new Date(l),s.sources[X].forEach(g=>{g.quality_key.toLocaleLowerCase()==="qxa"&&(r=g.src)});const p=typeof s.is_drm_protected!="undefined"?s.is_drm_protected:null;return{type:a,title:s.headline||s.title,drm:p,date:l,link:r,img:s.image&&s.image.image&&s.image.image.player&&s.image.image.player.url||null}},n=o(e,"all");return t.push(n),e.segments&&e.segments.forEach(s=>{const a=o(s);t.push(a)}),t},me=()=>{let e=[],t,o;const n=c=>{const u=c.filter(w=>w.quality===re&&w.delivery===X);return u.length===0?null:u[0].src};if(window.jsb&&window.jsb.last_event_values&&window.jsb.last_event_values["VideoPlaylist::INITIALIZED"]?t=window.jsb.last_event_values["VideoPlaylist::INITIALIZED"]:document.querySelectorAll(".player_viewport [data-jsb]").forEach(u=>{if(u.dataset&&u.dataset.jsb){let w=JSON.parse(u.dataset.jsb);if(w.playlist){t=w;return}}}),!t)return e;o=t.playlist;let s=t.drm,a,r,l;r=o.preview_image_url,l=o.title;const p=o.gapless_video;if(p){const c=n(p.sources);c&&(a=c)}else{let c=o.videos,u=[];for(var m=0;m<c.length;m++){let w=c[m];const j=n(w.sources);j&&(a=j,u.push(a))}a="",u.forEach((w,j)=>{a+="yt-dlp "+w+' -o "'+l+"_"+(j+1)+'.mp4" && '}),a&&(a=a.slice(0,-4))}let g=de(o.videos[0].sources[0].src);return e.push({type:"all",title:l,drm:s,date:g,link:a,img:r}),a="",o.videos.forEach(c=>{const u=n(c.sources);u&&(a=u),e.push({type:"single",title:c.title,drm:s,date:g,link:a,img:c.preview_image_url})}),e},ge=e=>Y(this,null,function*(){if(e==="on.orf.at"){let t;try{t=yield ue()}catch(n){return console.log(n),!1}return fe(t)}else if(e==="tvthek.orf.at")return me()}),ye=e=>{const t=e==="*"?"all":"single";return b.filter(n=>n.type===t&&(e==="*"||n.title.toLowerCase().match(e.replaceAll("*",".*").toLowerCase())))},H=(e,t=2)=>("0"+e).slice(-t),ve=e=>{const t=e.target;if(C&&(C.classList.remove("active"),C.querySelector(".l3-9556-copy").style.display="none"),t.nodeName.toLocaleLowerCase()==="img"&&t.dataset.drm&&t.dataset.drm==="false"){if(he(e)){const n=t.parentElement,s=n.querySelector(".l3-9556-copy");clearTimeout(x),s.style.display="block",x=setTimeout(()=>{n.classList.add("active"),n.classList.add("success"),x=setTimeout(()=>{n.classList.remove("success"),x=setTimeout(()=>{s.style.display="none"},200)},500)},1),C=n}}else t.nodeName.toLocaleLowerCase()==="button"&&typeof t.dataset.share!="undefined"&&we(e)},he=e=>{let t=e.target.parentElement.nextElementSibling;if(t.select(),navigator.clipboard){let o=t.innerHTML;return navigator.clipboard.writeText(o).then(()=>console.log("successful"),n=>console.log("error",n))}return document.execCommand("copy")},we=e=>{if(!navigator.share)return!1;const t=e.target,o=t.dataset.shareTitle,n=t.dataset.shareUrl;navigator.share({title:o,url:n}).then(()=>console.log("successful share")).catch(s=>console.log("error sharing:",s))},J=e=>{if(!e.length)return null;const t=new DocumentFragment;for(let o=e.length-1;o>=0;o--){const n=e[o],s=i("div",{class:"l3-9556-result"}),a=i("div",{class:"l3-9556-bar"}),r=i("div",{class:"l3-9556-title"});r.innerHTML=n.title,a.append(r);const l=i("textarea",{class:"l3-9556-ta",disabled:"true"},{position:"absolute",left:"-999em",opacity:0}),p=i("div",{class:"l3-9556-imgWrap",title:q.btn}),m=i("div",{class:"l3-9556-copy"},{display:"none"});m.innerHTML="copied";const g=i("img",{src:n.img,width:"150"},{flex:"auto"});g.dataset.drm=n.drm===null?!1:n.drm,p.append(g),p.append(m);let c;if(!n.drm){const u=n.date.getFullYear(),w=H(+n.date.getMonth()+1),j=H(n.date.getDate()),De=H(n.date.getHours()),Ee=H(n.date.getMinutes()),Ne=`${u}-${w}-${j}`,ke=`${De}${Ee}`;let te=n.title.toLowerCase().replaceAll('"',"");te.replaceAll("'","");const Ae=`${Ne}_${ke}_${te}.mp4`;c=`yt-dlp ${n.link} -o '${Ae}'`;const V=i("button",{class:"l3-9556-shareBtn"});V.dataset.share=!0,V.dataset.shareUrl=n.link,V.title="share video link",a.append(V)}l.innerHTML=c,s.append(a),s.append(p),s.append(l),t.append(s)}z.append(t)},be=()=>{v.style.display="block",x=setTimeout(()=>{v.classList.add("open"),f.classList.add("open"),h&&h.focus(),T=!0,_.set(A,{open:T}),clearTimeout(x)},1)},Le=()=>{v.classList.remove("open"),f.classList.remove("open"),x=setTimeout(()=>{v.style.display="none",T=!1,_.set(A,{open:T}),clearTimeout(x)},100)},xe=()=>{T?Le():be()},R=e=>{if(S===e)return;const t=ye(e);z.innerHTML="",D.style.display=t.length?"block":"none",J(t),_.set(A,{search:e}),S=e},Me=()=>{h.value="",h.dispatchEvent(new Event("input")),h.focus()},K=e=>{if(e){I.style.display="none",F=!1;return}F||(I.style.display="flex",F=!0)},Te=e=>{const t=e.currentTarget.value;R(t),K(t==="")},Ie=e=>{let t;return typeof e.pageX!="undefined"?t=e:t=e.touches[0]||e.changedTouches[0],{x:t.pageX,y:t.pageY}},Z=e=>{e.stopPropagation(),e.preventDefault(),e.type==="touchstart"?(f.removeEventListener("mousedown",Z),window.addEventListener("touchmove",B,M),window.addEventListener("touchend",U,!1)):e.type==="mousedown"&&(f.removeEventListener("touchstart",Z),window.addEventListener("mousemove",B,!1),window.addEventListener("mouseup",U,!1))},B=e=>{e.preventDefault();let{x:t,y:o}=Ie(e);t=Math.max(0,t),o=Math.max(0,o),f.style.left=t+"px",f.style.top=o+"px"},U=e=>{e.type==="touchend"?(window.removeEventListener("touchmove",B,M),window.removeEventListener("touchend",U)):e.type==="mouseup"&&(window.removeEventListener("mousemove",B,!1),window.removeEventListener("mouseup",U,!1))},je=()=>{const e=b.length-1,t=e===1,o=i("div",{id:"l3-9556"}),n=i("div",{id:"l3-9556-body"});if(v=i("div",{id:"l3-9556-box"},{display:"none"}),D=i("div",{class:"l3-9556-info"}),D.innerHTML=q.btn,!t){D.style.display="none";const r=i("div",{id:"l3-9556-header"}),l=i("div",{class:"l3-9556-info"});l.innerHTML=`Number of Videos: ${e}`,r.append(l);const p=i("div",{id:"l3-9556-filter"});h=i("input",{type:"text",id:"l3-9556-field",name:"fake_user[name]",value:"",autocomplete:"new-password",spellcheck:"false","aria-autocomplete":"none",placeholder:"filter videos by name ..."});const m=i("div",{class:"l3-9556-info"});m.innerHTML="Type * to see the full episode/broadcast",I=document.createElement("div"),I.id="l3-9556-clear",I.innerHTML="X",K(!0),p.append(h),p.append(I),r.append(p),r.append(m),I.addEventListener("click",Me,!1),h.addEventListener("input",Te,!1),v.append(r)}f=i("div",{id:"l3-9556-close"}),f.addEventListener("click",xe),f.addEventListener("mousedown",Z),f.addEventListener("touchstart",Z,M),z=i("div",{id:"l3-9556-content"});const s=i("div",{id:"l3-9556-footer"});s.innerHTML=`v-${le}`,n.append(D),n.append(z),v.append(n),v.append(s),o.append(v),o.append(f);const a=i("style");a.innerHTML=ce,document.body.append(a),document.body.append(o),o.addEventListener("click",ve)},_e=()=>{window.__NUXT__.data&&window.__NUXT__.data[P]&&delete window.__NUXT__.data[P],P=null,O=S,S=null,window.orfdl_initialized=!1,ee(!1)},ee=(e=!0)=>Y(this,null,function*(){if(window.orfdl_initialized)return!1;window.orfdl_initialized=!0,_=new E;let t=_.get(A);t&&(typeof t.search!="undefined"&&(O=t.search),typeof t.open!="undefined"&&(T=t.open));const o=window.location.host;if(b=yield ge(o),window.dataObject=b,!b||!b.length)return;if(e&&je(),T&&(v.classList.add("open"),v.style.display="block",f.classList.add("open")),b&&b.length===2){const s=b.filter(a=>a.type==="single");J(s);return}h.value=O,h.dispatchEvent(new Event("input")),R(O),h.focus()});setTimeout(ee,10)})();
