// ==UserScript==
// @name         ORF DL
// @namespace    https://github.com/lemon3/
// @version      0.6.1
// @description  orf tvthek video download helper
// @author       lemon3
// @match        https://*.tvthek.orf.at/profile/*
// @match        https://on.orf.at/video/*
// @icon         https://raw.githubusercontent.com/lemon3/orfdl/main/_assets/dl.svg
// @grant        none
// @run-at       document-end
// @license      MIT
// @copyright    lemon3
// @homepage     https://github.com/lemon3/orfdl
// @updateURL    https://raw.githubusercontent.com/lemon3/orfdl/main/dist/orfdl.meta.js
// @downloadURL  https://raw.githubusercontent.com/lemon3/orfdl/main/dist/orfdl.user.js
// ==/UserScript==

var Ze=Object.defineProperty;var ae=Object.getOwnPropertySymbols;var Be=Object.prototype.hasOwnProperty,Ue=Object.prototype.propertyIsEnumerable;var ce=(g,a,r)=>a in g?Ze(g,a,{enumerable:!0,configurable:!0,writable:!0,value:r}):g[a]=r,X=(g,a)=>{for(var r in a||(a={}))Be.call(a,r)&&ce(g,r,a[r]);if(ae)for(var r of ae(a))Ue.call(a,r)&&ce(g,r,a[r]);return g};var $=(g,a,r)=>new Promise((l,k)=>{var W=x=>{try{A(r.next(x))}catch(O){k(O)}},T=x=>{try{A(r.throw(x))}catch(O){k(O)}},A=x=>x.done?l(x.value):Promise.resolve(x.value).then(W,T);A((r=r.apply(g,a)).next())});(function(){"use strict";const g="body.dragging>*{-webkit-touch-callout:none;-webkit-user-select:none;user-select:none}#l3-2648{--color-1: #000;--color-2: #222;--color-3: #72bbe9;--color-4: #c9c9c9;--color-5: #222222;--font-small: 12px;--font-tiny: 10px}#l3-2648{position:fixed;top:0;left:0;z-index:99999;font-family:Arial,Helvetica Neue,Helvetica,sans-serif;color:var(--color-4)}#l3-2648 .l3-2648-info{font-size:var(--font-small)}#l3-2648-body .l3-2648-info{padding:15px}#l3-2648-clear{color:var(--color-1);background-color:var(--color-3);width:32px;height:38px;box-sizing:border-box;flex:none;text-align:center;justify-content:center;padding:.5em;cursor:pointer}#l3-2648-header{width:100%;padding:15px}#l3-2648-header.hidden{display:none}#l3-2648-filter{display:flex;align-items:stretch;margin-top:.5em}#l3-2648-content{max-height:260px;overflow:scroll}#l3-2648-close{z-index:999999;position:absolute;top:19px;left:15px;padding:0;background-image:url(data:image/svg+xml;base64,PHN2ZyBlbmFibGUtYmFja2dyb3VuZD0ibmV3IDAgMCAyNTYgMjU2IiB2aWV3Qm94PSIwIDAgMjU2IDI1NiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyBmaWxsPSIjZmZmIj48cGF0aCBkPSJtMjQzLjIgMTE5LjZ2MTYuOGgtMjMwLjR2LTE2Ljh6Ii8+PHBhdGggZD0ibTI0My4yIDE3NC42djE2LjhoLTIzMC40di0xNi44eiIvPjxwYXRoIGQ9Im0yNDMuMiA2NC42djE2LjhoLTIzMC40di0xNi44eiIvPjwvZz48L3N2Zz4=);background-repeat:no-repeat;width:38px;height:38px;background-size:20px;background-color:var(--color-1);border-radius:50%;background-position:center center;box-shadow:0 2px 12px -3px #fffc;cursor:pointer;user-select:none}#l3-2648-close.open{background-image:url(data:image/svg+xml;base64,PHN2ZyBlbmFibGUtYmFja2dyb3VuZD0ibmV3IDAgMCAyNTYgMjU2IiB2aWV3Qm94PSIwIDAgMjU2IDI1NiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJtMjQ2LjUgMjM0LjctMTA2LjctMTA2LjcgMTA2LjctMTA2LjctMTEuOC0xMS45LTEwNi43IDEwNi43LTEwNi43LTEwNi42LTExLjggMTEuOSAxMDYuNiAxMDYuNi0xMDYuNiAxMDYuNiAxMS44IDExLjkgMTA2LjctMTA2LjYgMTA2LjcgMTA2Ljd6IiBmaWxsPSIjZmZmIi8+PC9zdmc+)}#l3-2648-field{font-size:16px;touch-action:none;padding:8px;height:38px;border:0;border-radius:0;color:var(--color-2);width:100%}#l3-2648-field:focus{outline:none}#l3-2648-box{z-index:999999;box-sizing:border-box;margin:0;top:64px;max-width:280px;width:280px;background-color:var(--color-1);transform:translate(-100%);position:relative;transition:transform .1s ease-out;border:1px solid var(--color-5)}#l3-2648-box.open{transform:translate(0);transition:transform .2s ease-out}#l3-2648 .l3-2648-shareBtn{background-image:url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCI+PHBhdGggZD0iTTE1Ljk4NCA1LjAxNmwtMS40MDYgMS40MDYtMS41OTQtMS41OTR2MTEuMTU2aC0xLjk2OVY0LjgyOEw5LjQyMSA2LjQyMiA4LjAxNSA1LjAxNiAxMS45OTkuOTg1em00LjAzMiA0Ljk2OFYyMXEwIC44NDQtLjU4NiAxLjQzdC0xLjQzLjU4Nkg2cS0uODQ0IDAtMS40My0uNTg2VDMuOTg0IDIxVjkuOTg0cTAtLjc5Ny41ODYtMS4zODNUNiA4LjAxNWgzdjEuOTY5SDZWMjFoMTJWOS45ODRoLTNWOC4wMTVoM3EuODQ0IDAgMS40My41ODZ0LjU4NiAxLjM4M3oiLz48L3N2Zz4=);width:32px;height:32px;background-color:var(--color-3);display:flex;background-size:70%;background-repeat:no-repeat;background-position:center center;flex:none;border:none}#l3-2648 .l3-2648-shareBtn:hover{background-color:var(--color-4);cursor:pointer}#l3-2648 .l3-2648-result{display:flex;flex-flow:row wrap;padding:1em}#l3-2648 .l3-2648-result:nth-child(odd){background-color:var(--color-5)}#l3-2648 .l3-2648-bar{width:100%;flex:1 1 100%;font-size:var(--font-small);display:flex;justify-content:space-between;align-items:center;margin-bottom:.5em}#l3-2648 .l3-2648-title{display:flex;padding:.5em .5em .5em 0;line-height:1.4em}#l3-2648 .l3-2648-copy{font-size:30px}#l3-2648 .l3-2648-imgWrap{width:100%;display:flex;position:relative}#l3-2648 .l3-2648-copy{position:absolute;text-align:center;width:100%;left:0;top:35%;background-color:#0006;padding:10px;opacity:0;transition:opacity ease-out .2s}#l3-2648 .success .l3-2648-copy{opacity:1}#l3-2648 .active{box-shadow:0 0 0 2px #ffff54;filter:brightness(1.2)}#l3-2648-footer{font-size:var(--font-tiny);text-align:right}",a=(e,t,n)=>{if(e=parseFloat(e,10),t=parseFloat(t,10),n=parseFloat(n,10),n<t){let o=n;n=t,t=o}return!isNaN(t)&&e<t?t:!isNaN(n)&&e>n?n:e},r=(e,t,n)=>{if(t)for(let o in t)Object.prototype.hasOwnProperty.call(t,o)&&e.setAttribute(o,t[o]);if(n)for(let o in n)Object.prototype.hasOwnProperty.call(n,o)&&(e.style[o]=n[o]);return e},l=(e,t,n)=>r(document.createElement(e),t,n),k=(e="cs",t=window)=>{var n=document.createElement("iframe");n.src="about:blank",n.style.display="none",document.body.appendChild(n);const o=n.contentWindow.console;return t[e]=o};class W{constructor(){}get(t,n){let o=localStorage.getItem(t);if(!o)return!1;let s=JSON.parse(o);return n?s[n]:s}set(t,n){const o=this.get(t)||{},s=X(X({},o),n);let i=JSON.stringify(s);localStorage.setItem(t,i)}}let T=!1;try{window.addEventListener("test",null,Object.defineProperty({},"passive",{get:function(){return T={passive:!1},!1}}))}catch(e){T=!1}const de={name:"orfdl",displayName:"ORF DL",version:"0.6.1",type:"module",description:"orf tvthek video download helper",main:"index.js",author:"lemon3",license:"MIT",scripts:{dev:"vite",build:"vite build",preview:"vite preview",lint:"eslint 'src/**/*.js' || true",prettify:"prettier --write 'src/**/*.*'",browserslistupdate:"npx update-browserslist-db@latest"},devDependencies:{eslint:"^9.3.0",prettier:"^3.2.5",vite:"^5.2.11","vite-plugin-banner":"^0.7.1","vite-plugin-create-file":"^0.1.0","vite-plugin-string-replace":"^1.1.2"},dependencies:{globals:"^15.2.0"}},pe=k("cs");window.cs=pe;let J=document.location.href;const ue=document.querySelector("body");new MutationObserver(()=>{J!==document.location.href&&(J=document.location.href,Oe())}).observe(ue,{childList:!0,subtree:!0});const R={btn:"Click on the image to copy the video-link to the clipboard"},fe=de.version,S="dl-app";let I=!0,z="",E,ge="Q8C",K="hls";const me=g.toString();let M,Q,h=[],C,m,H,D,y,u,j,_,G,P,Z,ee,te,q;const ye=e=>{if(!e)return new Date;const t=e.match(/(\d{4})[_-](\d\d)[_-](\d\d)[_-](\d{4})/);if(!t)return new Date;const n=t[1],o=t[2],s=t[3],i=t[4].slice(0,-2)+":"+t[4].slice(2);return new Date(`${n}-${o}-${s} ${i}`)},ve=e=>{e.advertising_mapping={},e.advertising_query_string="",e.adition_advertising_query_string="",e.show_display_ads=!1,e.show_instream_ads=!1,e.disable_display_ads_orf_platforms=!0,e.disable_instream_ads_orf_platforms=!0},he=()=>$(this,null,function*(){let e=0,t;return new Promise((n,o)=>{const s=()=>{e++;const i=window.__NUXT__.data,w=Object.entries(i);let d;if(w.forEach(b=>{const[L,f]=b;if(f.sources){d=f,ve(f),Z=L;return}}),d)e=0,n(d);else{if(e>20)return clearTimeout(t),t=null,o();t=setTimeout(()=>s(),150)}};s()})}),we=e=>{window.playerObject=e;const t=[],n=(s,i="single")=>{let w=null,d=s.date||s.episode_date;d=new Date(d),s.sources[K].forEach(f=>{f.quality_key.toLocaleLowerCase()==="qxa"&&(w=f.src)});const b=typeof s.is_drm_protected!="undefined"?s.is_drm_protected:null;return{type:i,title:s.headline||s.title,drm:b,date:d,link:w,img:s.image&&s.image.image&&s.image.image.player&&s.image.image.player.url||null}},o=n(e,"all");return t.push(o),e.segments&&e.segments.forEach(s=>{const i=n(s);t.push(i)}),t},be=()=>{let e=[],t,n;const o=c=>{const p=c.filter(v=>v.quality===ge&&v.delivery===K);return p.length===0?null:p[0].src};if(window.jsb&&window.jsb.last_event_values&&window.jsb.last_event_values["VideoPlaylist::INITIALIZED"]?t=window.jsb.last_event_values["VideoPlaylist::INITIALIZED"]:document.querySelectorAll(".player_viewport [data-jsb]").forEach(p=>{if(p.dataset&&p.dataset.jsb){let v=JSON.parse(p.dataset.jsb);if(v.playlist){t=v;return}}}),!t)return e;n=t.playlist;let s=t.drm,i,w,d;w=n.preview_image_url,d=n.title;const b=n.gapless_video;if(b){const c=o(b.sources);c&&(i=c)}else{let c=n.videos,p=[];for(var L=0;L<c.length;L++){let v=c[L];const N=o(v.sources);N&&(i=N,p.push(i))}i="",p.forEach((v,N)=>{i+="yt-dlp "+v+' -o "'+d+"_"+(N+1)+'.mp4" && '}),i&&(i=i.slice(0,-4))}let f=ye(n.videos[0].sources[0].src);return e.push({type:"all",title:d,drm:s,date:f,link:i,img:w}),i="",n.videos.forEach(c=>{const p=o(c.sources);p&&(i=p),e.push({type:"single",title:c.title,drm:s,date:f,link:i,img:c.preview_image_url})}),e},Le=e=>$(this,null,function*(){if(e==="on.orf.at"){let t;try{t=yield he()}catch(o){return console.log(o),!1}return we(t)}else if(e==="tvthek.orf.at")return be()}),xe=e=>{if(!h)return null;const t=e==="*"?"all":"single";return h.filter(o=>o.type===t&&(e==="*"||o.title.toLowerCase().match(e.replaceAll("*",".*").toLowerCase())))},B=(e,t=2)=>("0"+e).slice(-t),Me=e=>{const t=e.target;if(P&&(P.classList.remove("active"),P.querySelector(".l3-2648-copy").style.display="none"),t.nodeName.toLocaleLowerCase()==="img"&&t.dataset.drm&&t.dataset.drm==="false"){if(Te(e)){const o=t.parentElement,s=o.querySelector(".l3-2648-copy");clearTimeout(M),s.style.display="block",M=setTimeout(()=>{o.classList.add("active"),o.classList.add("success"),M=setTimeout(()=>{o.classList.remove("success"),M=setTimeout(()=>{s.style.display="none"},200)},500)},1),P=o}}else t.nodeName.toLocaleLowerCase()==="button"&&typeof t.dataset.share!="undefined"&&Ie(e)},Te=e=>{let t=e.target.parentElement.nextElementSibling;if(t.select(),navigator.clipboard){let n=t.innerHTML;return navigator.clipboard.writeText(n).then(()=>console.log("successful"),o=>console.log("error",o))}return document.execCommand("copy")},Ie=e=>{if(!navigator.share)return!1;const t=e.target,n=t.dataset.shareTitle,o=t.dataset.shareUrl;navigator.share({title:n,url:o}).then(()=>console.log("successful share")).catch(s=>console.log("error sharing:",s))},ne=e=>{if(!e.length)return null;const t=new DocumentFragment;for(let n=e.length-1;n>=0;n--){const o=e[n],s=l("div",{class:"l3-2648-result"}),i=l("div",{class:"l3-2648-bar"}),w=l("div",{class:"l3-2648-title"});w.innerHTML=o.title,i.append(w);const d=l("textarea",{class:"l3-2648-ta",disabled:"true"},{position:"absolute",left:"-999em",opacity:0}),b=l("div",{class:"l3-2648-imgWrap",title:R.btn}),L=l("div",{class:"l3-2648-copy"},{display:"none"});L.innerHTML="copied";const f=l("img",{src:o.img,width:"150"},{flex:"auto"});f.dataset.drm=o.drm===null?!1:o.drm,b.append(f),b.append(L);let c;if(!o.drm){const p=o.date.getFullYear(),v=B(+o.date.getMonth()+1),N=B(o.date.getDate()),Se=B(o.date.getHours()),ze=B(o.date.getMinutes()),Ce=`${p}-${v}-${N}`,He=`${Se}${ze}`;let re=o.title.toLowerCase().replaceAll('"',"");re.replaceAll("'","");const Pe=`${Ce}_${He}_${re}.mp4`;c=`yt-dlp ${o.link} -o '${Pe}'`;const V=l("button",{class:"l3-2648-shareBtn"});V.dataset.share=!0,V.dataset.shareUrl=o.link,V.title="share video link",i.append(V)}d.innerHTML=c,s.append(i),s.append(b),s.append(d),t.append(s)}H.append(t)},je=()=>{m.style.display="block",M=setTimeout(()=>{m.classList.add("open"),u.classList.add("open"),y&&y.focus(),I=!0,E.set(S,{open:I}),clearTimeout(M)},1)},_e=()=>{m.classList.remove("open"),u.classList.remove("open"),M=setTimeout(()=>{m.style.display="none",I=!1,E.set(S,{open:I}),clearTimeout(M)},100)},Ne=()=>{if(q)return!1;I?_e():je()},oe=e=>{if(C===e)return;const t=xe(e);t&&(H.innerHTML="",D.style.display=t.length?"block":"none",ne(t),E.set(S,{search:e}),C=e)},Ee=()=>{y.value="",y.dispatchEvent(new Event("input")),y.focus()},se=e=>{if(e){j.style.display="none",Q=!1;return}Q||(j.style.display="flex",Q=!0)},De=e=>{const t=e.currentTarget.value;oe(t),se(t==="")},ke=e=>{let t;return typeof e.clientX!="undefined"?t=e:t=e.touches[0]||e.changedTouches[0],{x:t.clientX,y:t.clientY}},U=e=>{q=!1,document.body.classList.add("dragging"),e.stopPropagation(),e.type==="touchstart"?(u.removeEventListener("mousedown",U),window.addEventListener("touchmove",Y,T),window.addEventListener("touchend",F,!1)):e.type==="mousedown"&&(u.removeEventListener("touchstart",U),window.addEventListener("mousemove",Y,!1),window.addEventListener("mouseup",F,!1))},Y=e=>{e.preventDefault();let{x:t,y:n}=ke(e);q=!0,t-=19,n-=19,t=a(t,0,ee-38),n=a(n,0,te-38),u.style.left=t+"px",u.style.top=n+"px"},F=e=>{e.type==="touchend"?(window.removeEventListener("touchmove",Y,T),window.removeEventListener("touchend",F)):e.type==="mouseup"&&(window.removeEventListener("mousemove",Y,!1),window.removeEventListener("mouseup",F,!1)),document.body.classList.remove("dragging")},ie=e=>{ee=window.innerWidth,te=window.innerHeight},Ae=()=>{const e=l("div",{id:"l3-2648"}),t=l("div",{id:"l3-2648-body"});m=l("div",{id:"l3-2648-box"},{display:"none"}),D=l("div",{class:"l3-2648-info"}),D.innerHTML=R.btn,D.style.display="none",_=l("div",{id:"l3-2648-header"}),G=l("div",{class:"l3-2648-info"}),G.innerHTML="Number of Videos:",_.append(G);const n=l("div",{id:"l3-2648-filter"});y=l("input",{type:"text",id:"l3-2648-field",name:"fake_user[name]",value:"",autocomplete:"new-password",spellcheck:"false","aria-autocomplete":"none",placeholder:"filter videos by name ..."});const o=l("div",{class:"l3-2648-info"});o.innerHTML="Type * to see the full episode/broadcast",j=document.createElement("div"),j.id="l3-2648-clear",j.innerHTML="X",se(!0),n.append(y),n.append(j),_.append(n),_.append(o),j.addEventListener("click",Ee,!1),y.addEventListener("input",De,!1),m.append(_),u=l("div",{id:"l3-2648-close"}),u.addEventListener("click",Ne),window.addEventListener("resize",ie),ie(),u.addEventListener("mousedown",U),u.addEventListener("touchstart",U,T),H=l("div",{id:"l3-2648-content"});const s=l("div",{id:"l3-2648-footer"});s.innerHTML=`v-${fe}`,t.append(D),t.append(H),m.append(t),m.append(s),e.append(m),e.append(u);const i=l("style");i.innerHTML=me,document.body.append(i),document.body.append(e),e.addEventListener("click",Me)},Oe=()=>{window.__NUXT__.data&&window.__NUXT__.data[Z]&&delete window.__NUXT__.data[Z],Z=null,z=C,C=null,window.orfdl_initialized=!1,le(!1)},le=(e=!0)=>$(this,null,function*(){if(window.orfdl_initialized)return!1;window.orfdl_initialized=!0,E=new W;let t=E.get(S);t&&(typeof t.search!="undefined"&&(z=t.search),typeof t.open!="undefined"&&(I=t.open));const n=window.location.host;if(h=yield Le(n),window.dataObject=h,!h||!h.length)return;if(e&&(Ae(),h.length===2?_.classList.add("hidden"):_.classList.remove("hidden")),I&&(m.classList.add("open"),m.style.display="block",u.classList.add("open")),h&&h.length===2){const s=h.filter(i=>i.type==="single");ne(s);return}y.value=z,y.dispatchEvent(new Event("input")),oe(z),y.focus()});setTimeout(le,10)})();
